#!/bin/bash
#SBATCH --job-name=deepcoy_eval_batch
#SBATCH --output=/scratch1/aoxu/projects/VLS-Benchmark-Dataset/slurm/deepcoy_eval_batch_%j.out
#SBATCH --error=/scratch1/aoxu/projects/VLS-Benchmark-Dataset/slurm/deepcoy_eval_batch_%j.err
#SBATCH --time=24:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=32G
#SBATCH --partition=main

# =============================================================================
# DeepCoy Batch Evaluation - Evaluate generated decoys for all tested targets
#
# This script evaluates decoys generated by run_deepcoy_batch_test.sbatch.
# Runs on CPU (no GPU needed for evaluation).
#
# Usage:
#   sbatch run_deepcoy_batch_eval.sbatch
# =============================================================================

# Configuration
PROJECT_DIR="/scratch1/aoxu/projects/VLS-Benchmark-Dataset"
DEEPCOY_DIR="${PROJECT_DIR}/external/DeepCoy"
AFFINITY_DIR="${PROJECT_DIR}/data/chembl_affinity"
NUM_DECOYS_PER_ACTIVE=10  # Should match what was used in generation
NUM_CORES=8

# Load conda
module load conda/25.3.0
source activate /scratch1/aoxu/envs/deepcoy

echo "============================================="
echo "DeepCoy Batch Evaluation"
echo "============================================="
echo ""

# Find all generated decoy files from test runs
DECOY_FILES=()
for decoy_file in ${AFFINITY_DIR}/uniprot_*/deepcoy_output_test/*_generated_decoys.txt; do
    if [ -f "$decoy_file" ]; then
        DECOY_FILES+=("$decoy_file")
    fi
done

echo "Found ${#DECOY_FILES[@]} decoy files to evaluate"
echo ""

# Track results
SUCCESSFUL=0
FAILED=0
FAILED_IDS=""

# Process each decoy file
for i in "${!DECOY_FILES[@]}"; do
    DECOY_FILE="${DECOY_FILES[$i]}"
    
    # Extract UniProt ID from path
    dir_name=$(dirname "$DECOY_FILE")
    parent_dir=$(dirname "$dir_name")
    UNIPROT_ID=$(basename "$parent_dir" | sed 's/uniprot_//')
    
    OUTPUT_DIR="${dir_name}/evaluation"
    
    echo "============================================="
    echo "[$((i+1))/${#DECOY_FILES[@]}] Evaluating ${UNIPROT_ID}"
    echo "Input: ${DECOY_FILE}"
    echo "============================================="
    
    # Check decoy file has content
    NUM_LINES=$(wc -l < "$DECOY_FILE")
    if [ "$NUM_LINES" -lt 2 ]; then
        echo "WARNING: Decoy file too small (${NUM_LINES} lines), skipping"
        FAILED=$((FAILED + 1))
        FAILED_IDS="${FAILED_IDS} ${UNIPROT_ID}"
        continue
    fi
    echo "Decoy file has ${NUM_LINES} lines"
    
    # Create output directory
    mkdir -p ${OUTPUT_DIR}
    
    # Run evaluation
    # Note: select_and_evaluate_decoys.py expects either:
    # - A directory path (finds all files in it)
    # - A single file (but has a bug with absolute paths)
    # So we pass the directory and let it find the decoy file
    cd ${DEEPCOY_DIR}
    
    # Get just the filename for the script
    DECOY_FILENAME=$(basename "${DECOY_FILE}")
    DECOY_DIR=$(dirname "${DECOY_FILE}")/
    
    python evaluation/select_and_evaluate_decoys.py \
        --data_path "${DECOY_DIR}" \
        --output_path "${OUTPUT_DIR}/" \
        --dataset_name dude \
        --num_decoys_per_active ${NUM_DECOYS_PER_ACTIVE} \
        --min_num_candidates 10 \
        --num_cores ${NUM_CORES}
    
    # Check if evaluation produced output
    if [ -d "${OUTPUT_DIR}" ] && [ "$(ls -A ${OUTPUT_DIR})" ]; then
        echo "Evaluation complete for ${UNIPROT_ID}"
        SUCCESSFUL=$((SUCCESSFUL + 1))
    else
        echo "ERROR: Evaluation failed for ${UNIPROT_ID}"
        FAILED=$((FAILED + 1))
        FAILED_IDS="${FAILED_IDS} ${UNIPROT_ID}"
    fi
    
    echo ""
done

# Final summary
echo "============================================="
echo "BATCH EVALUATION COMPLETE"
echo "============================================="
echo "Total targets evaluated: ${#DECOY_FILES[@]}"
echo "Successful: ${SUCCESSFUL}"
echo "Failed: ${FAILED}"
if [ -n "$FAILED_IDS" ]; then
    echo "Failed IDs:${FAILED_IDS}"
fi
echo ""
echo "Evaluation results: ${AFFINITY_DIR}/uniprot_*/deepcoy_output_test/evaluation/"
echo "============================================="
