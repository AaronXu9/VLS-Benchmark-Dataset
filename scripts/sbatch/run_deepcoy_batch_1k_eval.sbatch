#!/bin/bash
#SBATCH --job-name=deepcoy_eval_1k
#SBATCH --output=/scratch1/aoxu/projects/VLS-Benchmark-Dataset/slurm/deepcoy_eval_1k_%j.out
#SBATCH --error=/scratch1/aoxu/projects/VLS-Benchmark-Dataset/slurm/deepcoy_eval_1k_%j.err
#SBATCH --time=12:00:00
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=64G
#SBATCH --partition=main

# =============================================================================
# DeepCoy Evaluation for 1000-decoy batch
#
# Evaluates decoys generated by run_deepcoy_batch_1k.sbatch
# With 1000 candidates, we can properly select 50 decoys per active
#
# Usage:
#   sbatch run_deepcoy_batch_1k_eval.sbatch
# =============================================================================

# Configuration
PROJECT_DIR="/scratch1/aoxu/projects/VLS-Benchmark-Dataset"
DEEPCOY_DIR="${PROJECT_DIR}/external/DeepCoy"
AFFINITY_DIR="${PROJECT_DIR}/data/chembl_affinity"
NUM_DECOYS_PER_ACTIVE=50   # Select 50 best decoys per active
MIN_NUM_CANDIDATES=100     # Require at least 100 candidates to choose from
NUM_CORES=8

# Input directory suffix (must match generation script)
INPUT_SUFFIX="deepcoy_output_1k"

# Load conda
module load conda/25.3.0
source activate /scratch1/aoxu/envs/deepcoy

echo "============================================="
echo "DeepCoy Evaluation - 1000 Decoy Batch"
echo "Selecting ${NUM_DECOYS_PER_ACTIVE} decoys per active"
echo "Min candidates required: ${MIN_NUM_CANDIDATES}"
echo "============================================="
echo ""

# Find all generated decoy files
DECOY_FILES=()
for decoy_file in ${AFFINITY_DIR}/uniprot_*/${INPUT_SUFFIX}/*_generated_decoys.txt; do
    if [ -f "$decoy_file" ]; then
        DECOY_FILES+=("$decoy_file")
    fi
done

echo "Found ${#DECOY_FILES[@]} decoy files to evaluate"
echo ""

# Track results
SUCCESSFUL=0
FAILED=0
FAILED_IDS=""

# Process each decoy file
for i in "${!DECOY_FILES[@]}"; do
    DECOY_FILE="${DECOY_FILES[$i]}"
    
    # Extract UniProt ID from path
    dir_name=$(dirname "$DECOY_FILE")
    parent_dir=$(dirname "$dir_name")
    UNIPROT_ID=$(basename "$parent_dir" | sed 's/uniprot_//')
    
    OUTPUT_DIR="${dir_name}/evaluation"
    
    echo "============================================="
    echo "[$((i+1))/${#DECOY_FILES[@]}] Evaluating ${UNIPROT_ID}"
    echo "Input: ${DECOY_FILE}"
    echo "============================================="
    
    # Check decoy file has content
    NUM_LINES=$(wc -l < "$DECOY_FILE")
    if [ "$NUM_LINES" -lt 100 ]; then
        echo "WARNING: Decoy file too small (${NUM_LINES} lines), skipping"
        FAILED=$((FAILED + 1))
        FAILED_IDS="${FAILED_IDS} ${UNIPROT_ID}"
        continue
    fi
    echo "Decoy file has ${NUM_LINES} lines"
    
    # Create output directory
    mkdir -p ${OUTPUT_DIR}
    
    # Run evaluation
    cd ${DEEPCOY_DIR}
    
    # Get just the directory for the script
    DECOY_DIR=$(dirname "${DECOY_FILE}")/
    
    python evaluation/select_and_evaluate_decoys.py \
        --data_path "${DECOY_DIR}" \
        --output_path "${OUTPUT_DIR}/" \
        --dataset_name dude \
        --num_decoys_per_active ${NUM_DECOYS_PER_ACTIVE} \
        --min_num_candidates ${MIN_NUM_CANDIDATES} \
        --num_cores ${NUM_CORES}
    
    # Check if evaluation produced output
    if [ -f "${OUTPUT_DIR}/results.csv" ]; then
        echo "Evaluation complete for ${UNIPROT_ID}"
        cat "${OUTPUT_DIR}/results.csv"
        SUCCESSFUL=$((SUCCESSFUL + 1))
    else
        echo "ERROR: Evaluation failed for ${UNIPROT_ID}"
        FAILED=$((FAILED + 1))
        FAILED_IDS="${FAILED_IDS} ${UNIPROT_ID}"
    fi
    
    echo ""
done

# Final summary
echo "============================================="
echo "BATCH EVALUATION COMPLETE"
echo "============================================="
echo "Total targets evaluated: ${#DECOY_FILES[@]}"
echo "Successful: ${SUCCESSFUL}"
echo "Failed: ${FAILED}"
if [ -n "$FAILED_IDS" ]; then
    echo "Failed IDs:${FAILED_IDS}"
fi
echo ""
echo "Results location: ${AFFINITY_DIR}/uniprot_*/${INPUT_SUFFIX}/evaluation/"
echo "============================================="

# Aggregate all results into a summary file
echo ""
echo "Creating aggregated summary..."
SUMMARY_FILE="${PROJECT_DIR}/data/deepcoy_evaluation_summary_1k.csv"
echo "File name,Dataset,Orig num actives,Num actives,Num generated mols,Num unique gen mols,AUC ROC - 1NN,AUC ROC - RF,DOE score,LADS score,Doppelganger score mean,Doppelganger score max" > ${SUMMARY_FILE}

for results_file in ${AFFINITY_DIR}/uniprot_*/${INPUT_SUFFIX}/evaluation/results.csv; do
    if [ -f "$results_file" ]; then
        # Skip header line and append data
        tail -n +2 "$results_file" >> ${SUMMARY_FILE}
    fi
done

echo "Aggregated summary saved to: ${SUMMARY_FILE}"
